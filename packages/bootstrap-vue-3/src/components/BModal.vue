<template>
  <teleport to="body">
    <div :id="id" ref="element" class="modal" :class="modalClasses" tabindex="-1" v-bind="$attrs">
      <div class="modal-dialog" :class="modalDialogClasses">
        <div class="modal-content" :class="contentClass">
          <div v-if="!hideHeaderBoolean" class="modal-header" :class="computedHeaderClasses">
            <component :is="titleTag" class="modal-title" :class="computedTitleClasses">
              <slot name="title">
                {{ title }}
              </slot>
            </component>
            <button
              v-if="!hideHeaderCloseBoolean"
              type="button"
              class="btn-close"
              :class="computedCloseButtonClasses"
              data-bs-dismiss="modal"
              :aria-label="headerCloseLabel"
            >
              <slot name="header-close"></slot>
            </button>
          </div>
          <div class="modal-body" :class="computedBodyClasses">
            <slot />
          </div>
          <div v-if="!hideFooterBoolean" class="modal-footer" :class="computedFooterClasses">
            <slot name="footer">
              <b-button
                v-if="!okOnlyBoolean"
                type="button"
                class="btn"
                data-bs-dismiss="modal"
                :disabled="disableCancel"
                :size="buttonSize"
                :variant="cancelVariant"
                @click="$emit('cancel')"
              >
                {{ cancelTitle }}
              </b-button>
              <b-button
                type="button"
                class="btn"
                data-bs-dismiss="modal"
                :disabled="disableOk"
                :size="buttonSize"
                :variant="okVariant"
                @click="$emit('ok')"
              >
                {{ okTitle }}
              </b-button>
            </slot>
          </div>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script setup lang="ts">
// import type {BModalEmits, BModalProps} from '../types/components'
import Modal from 'bootstrap/js/dist/modal'
import BButton from './BButton/BButton.vue'
import {resolveBooleanish} from '../utils'
import {useEventListener} from '../composables'
import {computed, onMounted, ref, useSlots, watch} from 'vue'
import type {Booleanish, ColorVariant, InputSize} from '../types'

interface BModalProps {
  bodyBgVariant?: ColorVariant
  bodyClass?: string
  bodyTextVariant?: ColorVariant
  busy?: Booleanish
  buttonSize?: InputSize
  cancelDisabled?: Booleanish
  cancelTitle?: string
  cancelVariant?: ColorVariant
  centered?: Booleanish
  contentClass?: string
  dialogClass?: string
  footerBgVariant?: ColorVariant
  footerBorderVariant?: ColorVariant
  footerClass?: string
  footerTextVariant?: ColorVariant
  fullscreen?: boolean | string
  headerBgVariant?: ColorVariant
  headerBorderVariant?: ColorVariant
  headerClass?: string
  headerCloseLabel?: string
  headerCloseWhite?: Booleanish
  headerTextVariant?: ColorVariant
  hideBackdrop?: Booleanish
  hideFooter?: Booleanish
  hideHeader?: Booleanish
  hideHeaderClose?: Booleanish
  id?: string
  modalClass?: string
  modelValue?: Booleanish
  noCloseOnBackdrop?: Booleanish
  noCloseOnEsc?: Booleanish
  noFade?: Booleanish
  noFocus?: Booleanish
  okDisabled?: Booleanish
  okOnly?: Booleanish
  okTitle?: string
  okVariant?: ColorVariant
  scrollable?: Booleanish
  show?: Booleanish
  size?: string
  title?: string
  titleClass?: string
  titleSrOnly?: Booleanish
  titleTag?: string
}

const props = withDefaults(defineProps<BModalProps>(), {
  busy: false,
  buttonSize: 'md',
  cancelDisabled: false,
  cancelTitle: 'Cancel',
  cancelVariant: 'secondary',
  centered: false,
  fullscreen: false,
  headerCloseLabel: 'Close',
  headerCloseWhite: false,
  hideBackdrop: false,
  hideFooter: false,
  hideHeader: false,
  hideHeaderClose: false,
  modelValue: false,
  noCloseOnBackdrop: false,
  noCloseOnEsc: false,
  noFade: false,
  noFocus: false,
  okDisabled: false,
  okOnly: false,
  okTitle: 'Ok',
  okVariant: 'primary',
  scrollable: false,
  show: false,
  titleSrOnly: false,
  titleTag: 'h5',
})

const busyBoolean = computed<boolean>(() => resolveBooleanish(props.busy))
const cancelDisabledBoolean = computed<boolean>(() => resolveBooleanish(props.cancelDisabled))
const centeredBoolean = computed<boolean>(() => resolveBooleanish(props.centered))
const headerCloseWhiteBoolean = computed<boolean>(() => resolveBooleanish(props.headerCloseWhite))
const hideBackdropBoolean = computed<boolean>(() => resolveBooleanish(props.hideBackdrop))
const hideFooterBoolean = computed<boolean>(() => resolveBooleanish(props.hideFooter))
const hideHeaderBoolean = computed<boolean>(() => resolveBooleanish(props.hideHeader))
const hideHeaderCloseBoolean = computed<boolean>(() => resolveBooleanish(props.hideHeaderClose))
const modelValueBoolean = computed<boolean>(() => resolveBooleanish(props.modelValue))
const noCloseOnBackdropBoolean = computed<boolean>(() => resolveBooleanish(props.noCloseOnBackdrop))
const noCloseOnEscBoolean = computed<boolean>(() => resolveBooleanish(props.noCloseOnEsc))
const noFadeBoolean = computed<boolean>(() => resolveBooleanish(props.noFade))
const noFocusBoolean = computed<boolean>(() => resolveBooleanish(props.noFocus))
const okDisabledBoolean = computed<boolean>(() => resolveBooleanish(props.okDisabled))
const okOnlyBoolean = computed<boolean>(() => resolveBooleanish(props.okOnly))
const scrollableBoolean = computed<boolean>(() => resolveBooleanish(props.scrollable))
const showBoolean = computed<boolean>(() => resolveBooleanish(props.show))
const titleSrOnlyBoolean = computed<boolean>(() => resolveBooleanish(props.titleSrOnly))

interface BModalEmits {
  (e: 'update:modelValue', value: boolean): void
  (e: 'show', value: Event): void
  (e: 'shown', value: Event): void
  (e: 'hide', value: Event): void
  (e: 'hidden', value: Event): void
  (e: 'hide-prevented', value: Event): void
  (e: 'ok'): void
  (e: 'cancel'): void
}

const emit = defineEmits<BModalEmits>()

const slots = useSlots()

const element = ref<HTMLElement>()
const instance = ref<Modal>()
const modalClasses = computed(() => [
  {
    fade: !noFadeBoolean.value,
    show: showBoolean.value,
  },
  props.modalClass,
])
const modalDialogClasses = computed(() => [
  {
    'modal-fullscreen': typeof props.fullscreen === 'boolean' ? props.fullscreen : false,
    [`modal-fullscreen-${props.fullscreen}-down`]:
      typeof props.fullscreen === 'string' ? props.fullscreen : false,
    [`modal-${props.size}`]: props.size,
    'modal-dialog-centered': centeredBoolean.value,
    'modal-dialog-scrollable': scrollableBoolean.value,
  },
  props.dialogClass,
])

const computedBodyClasses = computed(() => [
  {
    [`bg-${props.bodyBgVariant}`]: props.bodyBgVariant,
    [`text-${props.bodyTextVariant}`]: props.bodyTextVariant,
  },
  props.bodyClass,
])

const computedHeaderClasses = computed(() => [
  {
    [`bg-${props.headerBgVariant}`]: props.headerBgVariant,
    [`border-${props.headerBorderVariant}`]: props.headerBorderVariant,
    [`text-${props.headerTextVariant}`]: props.headerTextVariant,
  },
  props.headerClass,
])

const computedFooterClasses = computed(() => [
  {
    [`bg-${props.footerBgVariant}`]: props.footerBgVariant,
    [`border-${props.footerBorderVariant}`]: props.footerBorderVariant,
    [`text-${props.footerTextVariant}`]: props.footerTextVariant,
  },
  props.footerClass,
])

const computedTitleClasses = computed(() => [
  {
    ['visually-hidden']: titleSrOnlyBoolean.value,
  },
  props.titleClass,
])

const hasHeaderCloseSlot = computed<boolean>(() => !!slots['header-close'])
const computedCloseButtonClasses = computed(() => [
  {
    [`btn-close-content`]: hasHeaderCloseSlot.value,
    [`d-flex`]: hasHeaderCloseSlot.value,
    [`btn-close-white`]: !hasHeaderCloseSlot.value && headerCloseWhiteBoolean.value,
  },
])

const disableCancel = computed<boolean>(() => cancelDisabledBoolean.value || busyBoolean.value)
const disableOk = computed<boolean>(() => okDisabledBoolean.value || busyBoolean.value)

useEventListener(element, 'shown.bs.modal', (e) => emit('shown', e))
useEventListener(element, 'hidden.bs.modal', (e) => emit('hidden', e))
useEventListener(element, 'hidePrevented.bs.modal', (e) => emit('hide-prevented', e))

useEventListener(element, 'show.bs.modal', (e) => {
  emit('show', e)
  if (!e.defaultPrevented) {
    emit('update:modelValue', true)
  }
})

useEventListener(element, 'hide.bs.modal', (e) => {
  emit('hide', e)
  if (!e.defaultPrevented) {
    emit('update:modelValue', false)
  }
})

onMounted(() => {
  instance.value = new Modal(element.value as HTMLElement, {
    backdrop: hideBackdropBoolean.value
      ? false
      : noCloseOnBackdropBoolean.value
      ? 'static'
      : !hideBackdropBoolean.value,
    keyboard: !noCloseOnEscBoolean.value,
    focus: !noFocusBoolean.value,
  })

  if (modelValueBoolean.value) {
    instance.value?.show()
  }
})

watch(
  () => props.noCloseOnBackdrop,
  (newValue) => {
    ;(instance.value as unknown as {_config: Modal.Options})._config.backdrop = props.hideBackdrop
      ? false
      : newValue
      ? 'static'
      : !props.hideBackdrop
  }
)

watch(
  () => props.noCloseOnEsc,
  (newValue) => {
    ;(instance.value as unknown as {_config: Modal.Options})._config.keyboard = !newValue
  }
)

watch(
  () => modelValueBoolean.value,
  (value) => {
    if (value) {
      instance.value?.show()
    } else {
      instance.value?.hide()
    }
  }
)
</script>

<script lang="ts">
export default {
  inheritAttrs: false,
}
</script>
